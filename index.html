<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>주변 주유소 안내</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin: 0; padding: 0; font-family: Arial; }
  #map { height: 70vh; width: 100%; }
  #list { height: 30vh; overflow-y: auto; padding: 10px; }
  .station-item { margin-bottom: 8px; cursor: pointer; }
</style>
</head>
<body>

<div id="map"></div>
<div id="list"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([37.5665, 126.9780], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat, lng], 14);
      L.marker([lat, lng]).addTo(map).bindPopup("내 위치").openPopup();

      // Flask 서버 프록시 호출
      const proxyURL = `/google-places-proxy?lat=${lat}&lng=${lng}&radius=5000&type=gas_station`;

      try {
        const res = await fetch(proxyURL);
        const data = await res.json();

        const listDiv = document.getElementById('list');
        listDiv.innerHTML = ""; // 초기화

        data.results.forEach(place => {
          // 지도 마커
          const marker = L.marker([place.geometry.location.lat, place.geometry.location.lng]).addTo(map);
          marker.bindPopup(`<strong>${place.name}</strong><br>주소: ${place.vicinity}`);

          // 리스트뷰
          const item = document.createElement('div');
          item.className = 'station-item';
          item.innerHTML = `<strong>${place.name}</strong> - ${place.vicinity}`;
          item.onclick = () => { 
            map.panTo([place.geometry.location.lat, place.geometry.location.lng]); 
            marker.openPopup(); 
          };
          listDiv.appendChild(item);
        });

      } catch (err) {
        console.error("Google Places API 호출 실패:", err);
        alert("주변 주유소 정보를 가져오지 못했습니다.");
      }
    }, err => {
      alert("위치 정보를 가져오지 못했습니다: " + err.message);
    });
  } else {
    alert("브라우저에서 위치 정보 사용이 불가합니다.");
  }
</script>

</body>
</html>
