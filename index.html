<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì£¼ë³€ ì£¼ìœ ì†Œ ì•ˆë‚´ (ë“œë¡œì‰ ê²€ìƒ‰)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
Â  body { margin: 0; padding: 0; font-family: Arial; }
Â  #map { height: 70vh; width: 100%; }
Â  #list { height: 30vh; overflow-y: auto; padding: 10px; }
Â  .station-item { margin-bottom: 8px; cursor: pointer; }
Â  .popup-input { width: 80px; margin-right: 5px; }
Â  #controls { position: absolute; top: 10px; left: 10px; z-index: 1000; }
Â  #toggleDraw { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
Â  #toggleDraw.active { background-color: #dc3545; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
Â  <button id="toggleDraw">ğŸ” ì˜ì—­ ì§€ì • ëª¨ë“œ</button>
</div>
<div id="list"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// í•­ìƒ PROXY_URLì€ ì„œë²„ ë£¨íŠ¸ë¡œ ì„¤ì • (ëì— /places ë¶™ì´ì§€ ì•ŠìŒ)
const PROXY_URL = "https://gas-proxy-1018660757410.asia-northeast3.run.app";

const map = L.map('map', {
Â  // ë“œë¡œì‰ ëª¨ë“œ ì‹œì‘ ì‹œ ë§µ ë“œë˜ê·¸ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” í•´ì œ
Â  dragging: true 
}).setView([37.5665, 126.9780], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â  attribution: 'Â© OpenStreetMap'
}).addTo(map);

let markers = L.layerGroup().addTo(map); // ë§ˆì»¤ ê·¸ë£¹
let currentCircle = null; // í˜„ì¬ ê·¸ë ¤ì§„ ì›

let isDrawingMode = false;
let startLatLng = null; // í„°ì¹˜ ì‹œì‘ì 

const toggleDrawBtn = document.getElementById('toggleDraw');

// --- ì£¼ìœ ì†Œ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ í•¨ìˆ˜ ---
async function loadAndDisplayGasStations(lat, lng, radius) {
Â  // ê¸°ì¡´ ë§ˆì»¤ì™€ ì› ì œê±°
Â  markers.clearLayers();
Â  if (currentCircle) {
Â  Â  map.removeLayer(currentCircle);
Â  Â  currentCircle = null;
Â  }

Â  const listDiv = document.getElementById('list');
Â  listDiv.innerHTML = 'ì£¼ìœ ì†Œ ê²€ìƒ‰ ì¤‘...';

Â  // API ìš”ì²­
Â  const url = `${PROXY_URL}/places?lat=${lat}&lng=${lng}&radius=${radius}`;
Â  let placesData;
Â  try {
Â  Â  placesData = await fetch(url).then(res => res.json());
Â  } catch (e) {
Â  Â  alert("ì£¼ìœ ì†Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
Â  Â  console.error(e);
Â  Â  listDiv.innerHTML = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨.';
Â  Â  return;
Â  }

Â  const results = placesData.results || [];
Â  listDiv.innerHTML = ''; // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

Â  if (results.length === 0) {
Â  Â  listDiv.innerHTML = 'ì§€ì •ëœ ì˜ì—­ì— ì£¼ìœ ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.';
Â  Â  return;
Â  }

Â  results.forEach(place => {
Â  Â  const { lat: pLat, lng: pLng } = place.geometry.location;

Â  Â  // íŒì—… ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì •ì˜
Â  Â  async function updatePopup(marker) {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${PROXY_URL}/getPrice/${encodeURIComponent(place.name)}`);
Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  const popupContent = `
Â  Â  Â  Â  Â  <strong>${place.name}</strong><br>
Â  Â  Â  Â  Â  ì£¼ì†Œ: ${place.vicinity || 'ì •ë³´ ì—†ìŒ'}<br>
Â  Â  Â  Â  Â  ê°€ê²©: ${data.price !== null ? `$${data.price}` : 'ì •ë³´ ì—†ìŒ'}<br>
Â  Â  Â  Â  Â  ì €ì¥ ì‹œê°„: ${data.timestamp ? new Date(data.timestamp).toLocaleString() : '-'}<br>
Â  Â  Â  Â  Â  <input type="number" id="priceInput" class="popup-input" placeholder="ê°€ê²© ì…ë ¥">
Â  Â  Â  Â  Â  <button id="saveBtn">ì €ì¥</button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  marker.bindPopup(popupContent, { autoClose: false });

Â  Â  Â  Â  // íŒì—… DOM ìƒì„± í›„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
Â  Â  Â  Â  marker.on('popupopen', () => {
Â  Â  Â  Â  Â  const saveBtn = document.getElementById('saveBtn');
Â  Â  Â  Â  Â  if (saveBtn) {
Â  Â  Â  Â  Â  Â  saveBtn.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  const priceInput = parseFloat(document.getElementById('priceInput').value);
Â  Â  Â  Â  Â  Â  Â  if (!isNaN(priceInput)) {
Â  Â  Â  Â  Â  Â  Â  Â  await fetch(`${PROXY_URL}/savePrice`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ station_name: place.name, price: priceInput })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  await updatePopup(marker); // íŒì—… ê°±ì‹ 
Â  Â  Â  Â  Â  Â  Â  Â  marker.closePopup();
Â  Â  Â  Â  Â  Â  Â  Â  marker.openPopup();
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”.");
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // ë§ˆì»¤ ìƒì„± ë° ê·¸ë£¹ì— ì¶”ê°€
Â  Â  const marker = L.marker([pLat, pLng]);
Â  Â  marker.on('click', () => updatePopup(marker));
Â  Â  markers.addLayer(marker);

Â  Â  // ë¦¬ìŠ¤íŠ¸ í•­ëª© ìƒì„±
Â  Â  const item = document.createElement('div');
Â  Â  item.className = 'station-item';
Â  Â  item.innerHTML = `<strong>${place.name}</strong> - ${place.vicinity || 'ì£¼ì†Œ ì—†ìŒ'}`;
Â  Â  item.onclick = () => {
Â  Â  Â  map.panTo([pLat, pLng]);
Â  Â  Â  updatePopup(marker).then(() => marker.openPopup());
Â  Â  };
Â  Â  listDiv.appendChild(item);

Â  Â  updatePopup(marker); // ì´ˆê¸° íŒì—… í‘œì‹œ
Â  });
}

// --- ë“œë¡œì‰ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜ ---
function toggleDrawingMode() {
Â  isDrawingMode = !isDrawingMode;
Â  if (isDrawingMode) {
Â  Â  toggleDrawBtn.classList.add('active');
Â  Â  toggleDrawBtn.textContent = 'âŒ ì˜ì—­ ì§€ì • ì·¨ì†Œ';
Â  Â  map.dragging.disable(); // ì§€ë„ ë“œë˜ê·¸ ë¹„í™œì„±í™”
Â  Â  map.touchZoom.disable();
Â  Â  map.doubleClickZoom.disable();
Â  Â  map.scrollWheelZoom.disable();
Â  Â  map.boxZoom.disable();
Â  Â  map.keyboard.disable();
Â  Â  map.getContainer().style.cursor = 'crosshair';
Â  Â  alert("ì§€ë„ë¥¼ í„°ì¹˜(í´ë¦­)í•˜ê³  ë“œë˜ê·¸í•˜ì—¬ ì›ì„ ê·¸ë¦° í›„ ë–¼ë©´ ì˜ì—­ì´ ì§€ì •ë©ë‹ˆë‹¤.");
Â  } else {
Â  Â  toggleDrawBtn.classList.remove('active');
Â  Â  toggleDrawBtn.textContent = 'ğŸ” ì˜ì—­ ì§€ì • ëª¨ë“œ';
Â  Â  map.dragging.enable(); // ì§€ë„ ë“œë˜ê·¸ í™œì„±í™”
Â  Â  map.touchZoom.enable();
Â  Â  map.doubleClickZoom.enable();
Â  Â  map.scrollWheelZoom.enable();
Â  Â  map.boxZoom.enable();
Â  Â  map.keyboard.enable();
Â  Â  map.getContainer().style.cursor = '';
Â  Â  // ì˜ì—­ ì§€ì • ì·¨ì†Œ ì‹œ í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•˜ë„ë¡ í•  ìˆ˜ë„ ìˆìŒ (ì„ íƒ ì‚¬í•­)
Â  Â  // if (currentLocation) loadAndDisplayGasStations(currentLocation.lat, currentLocation.lng, 5000);
Â  }
}
toggleDrawBtn.addEventListener('click', toggleDrawingMode);

// --- ë“œë¡œì‰ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
let tempCircle = null; // ë“œë˜ê·¸ ì¤‘ì¸ ì„ì‹œ ì›
let currentLocation = null; // í˜„ì¬ ìœ„ì¹˜ ì €ì¥

// 1. í„°ì¹˜/í´ë¦­ ì‹œì‘ (ì›ì˜ ì¤‘ì‹¬ì  ì„¤ì •)
function handlePointerDown(e) {
Â  if (!isDrawingMode) return;
Â  startLatLng = e.latlng;
Â  
Â  // ì„ì‹œ ì› ì‹œì‘
Â  tempCircle = L.circle(startLatLng, {
Â  Â  color: 'blue',
Â  Â  fillColor: '#007bff',
Â  Â  fillOpacity: 0.2,
Â  Â  radius: 0
Â  }).addTo(map);

Â  // ë§µ ì´ë™ ì‹œ ë“œë˜ê·¸ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€
Â  L.DomEvent.on(map.getContainer(), 'pointermove', handlePointerMove);
Â  L.DomEvent.on(map.getContainer(), 'pointerup', handlePointerUp);
}

// 2. í„°ì¹˜/ë“œë˜ê·¸ ì¤‘ (ë°˜ì§€ë¦„ ì—…ë°ì´íŠ¸)
function handlePointerMove(e) {
Â  if (!isDrawingMode || !startLatLng) return;

Â  const endLatLng = map.mouseEventToLatLng(e.originalEvent);
Â  const distance = startLatLng.distanceTo(endLatLng); // ë¯¸í„° ë‹¨ìœ„ ê±°ë¦¬ ê³„ì‚°

Â  // ì„ì‹œ ì› ì—…ë°ì´íŠ¸
Â  if (tempCircle) {
Â  Â  tempCircle.setRadius(distance);
Â  }
}

// 3. í„°ì¹˜/í´ë¦­ ì¢…ë£Œ (ì›í˜• ì˜ì—­ í™•ì • ë° ê²€ìƒ‰)
function handlePointerUp(e) {
Â  if (!isDrawingMode || !startLatLng) return;

Â  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
Â  L.DomEvent.off(map.getContainer(), 'pointermove', handlePointerMove);
Â  L.DomEvent.off(map.getContainer(), 'pointerup', handlePointerUp);

Â  const endLatLng = map.mouseEventToLatLng(e.originalEvent);
Â  const distance = startLatLng.distanceTo(endLatLng);

Â  // ìµœì†Œ ë°˜ì§€ë¦„ ì„¤ì • (ë„ˆë¬´ ì‘ì€ ì›ì€ ë¬´ì‹œ)
Â  if (distance < 50) { 
Â  Â  if (tempCircle) map.removeLayer(tempCircle);
Â  Â  startLatLng = null;
Â  Â  return;
Â  }

Â  // ê¸°ì¡´ ì› ì œê±° ë° ìƒˆë¡œìš´ ì› ì¶”ê°€
Â  if (currentCircle) map.removeLayer(currentCircle);
Â  currentCircle = tempCircle;
Â  currentCircle.setStyle({ color: 'red', fillColor: '#dc3545', fillOpacity: 0.3 }); // ìµœì¢… ì› ìŠ¤íƒ€ì¼

Â  // ì£¼ìœ ì†Œ ê²€ìƒ‰ ì‹¤í–‰
Â  // ìµœëŒ€ ê²€ìƒ‰ ë°˜ê²½ì€ 50000m (50km)ë¡œ ì œí•œ
Â  const searchRadius = Math.min(distance, 50000); 
Â  loadAndDisplayGasStations(startLatLng.lat, startLatLng.lng, searchRadius);

Â  // ë“œë¡œì‰ ëª¨ë“œ í•´ì œ
Â  toggleDrawingMode();

Â  startLatLng = null;
Â  tempCircle = null;
}

// ë¦¬í”„ë › ì´ë²¤íŠ¸ ë°”ì¸ë”©
map.on('pointerdown', handlePointerDown);

// --- ì´ˆê¸° ìœ„ì¹˜ ë° ë°ì´í„° ë¡œë“œ ---
navigator.geolocation.getCurrentPosition(async pos => {
Â  const lat = pos.coords.latitude;
Â  const lng = pos.coords.longitude;
Â  currentLocation = { lat, lng };

Â  map.setView([lat, lng], 14);
Â  L.marker([lat, lng]).addTo(map).bindPopup("í˜„ì¬ ë‚´ ìœ„ì¹˜").openPopup();

Â  // ì´ˆê¸° ê²€ìƒ‰ (í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ 5000m)
Â  await loadAndDisplayGasStations(lat, lng, 5000);

}, err => {
Â  alert("GPS ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message);
Â  // ìœ„ì¹˜ ì‹¤íŒ¨ ì‹œ ì„œìš¸ ì‹œì²­ ê¸°ë³¸ê°’ìœ¼ë¡œ ê²€ìƒ‰ ì‹œë„
Â  loadAndDisplayGasStations(37.5665, 126.9780, 5000); 
});
</script>

</body>
</html>
